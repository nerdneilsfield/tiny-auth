# tiny-auth 配置示例
# 完整配置文档：https://github.com/nerdneilsfield/tiny-auth

# ===== 服务器配置 =====
[server]
port = "8080"              # 监听端口（可通过环境变量 PORT 覆盖）
auth_path = "/auth"        # ForwardAuth 端点路径
health_path = "/health"    # 健康检查端点路径
read_timeout = 5           # 读超时（秒）
write_timeout = 5          # 写超时（秒）

# ===== Header 配置 =====
[headers]
user_header = "X-Auth-User"           # 用户名 header
role_header = "X-Auth-Role"           # 角色 header
method_header = "X-Auth-Method"       # 认证方法 header
extra_headers = ["X-Auth-Timestamp"]  # 额外注入的 headers
include_jwt_metadata = false          # 是否包含 JWT 元数据 headers

# ===== 日志配置 =====
[logging]
format = "text"  # 日志格式: "json" 或 "text"
level = "info"   # 日志级别: "debug", "info", "warn", "error"

# ===== Basic Auth 配置 =====
# 支持多个用户，每个用户有独立的角色

[[basic_auth]]
name = "admin-user"
user = "admin"
pass = "supersecret"              # 支持 env:VAR_NAME 语法
roles = ["admin", "user"]

[[basic_auth]]
name = "dev-user"
user = "dev"
pass = "env:DEV_PASSWORD"         # 从环境变量读取密码
roles = ["developer"]

# ===== Bearer Token 配置 =====
# 支持静态 Bearer Token

[[bearer_token]]
name = "prod-token"
token = "sk-live-abc123xyz789"
roles = ["admin", "service"]

[[bearer_token]]
name = "test-token"
token = "env:TEST_TOKEN"          # 从环境变量读取
roles = ["readonly", "tester"]

# ===== API Key 配置 =====
# 支持通过 Authorization: ApiKey xxx 或 X-Api-Key header

[[api_key]]
name = "prod-key"
key = "ak_prod_xxx_secret"
roles = ["admin"]

[[api_key]]
name = "readonly-key"
key = "env:READONLY_API_KEY"
roles = ["readonly"]

# ===== JWT 配置 =====
# 可选：如果不配置则不支持 JWT
[jwt]
secret = "your-256-bit-secret-key-here-must-be-at-least-32-chars-long"
issuer = "auth-service"           # 期望的 issuer (iss claim)
audience = "api"                  # 期望的 audience (aud claim)

# ===== 路由策略配置 =====
# 可选：基于 host/path/method 的细粒度认证控制

# 示例：公共 API 允许匿名访问
[[route_policy]]
name = "public-api"
host = "api.public.com"
path_prefix = "/public"
allow_anonymous = true

# 示例：Webhook 端点只允许特定 Bearer Token
[[route_policy]]
name = "webhook-endpoint"
host = "hooks.example.com"
path_prefix = "/webhook"
allowed_bearer_names = ["prod-token"]
inject_authorization = "Bearer upstream-webhook-token"  # 可选：注入上游 Authorization

# 示例：管理面板只允许 admin 用户
[[route_policy]]
name = "admin-panel"
host = "admin.example.com"
allowed_basic_names = ["admin-user"]
require_all_roles = ["admin"]

# 示例：内部 API 只允许 JWT
[[route_policy]]
name = "internal-api"
host = "internal.example.com"
jwt_only = true

# 示例：混合认证（要求特定角色）
[[route_policy]]
name = "mixed-auth"
host = "mixed.example.com"
require_any_role = ["admin", "service"]  # 必须有 admin 或 service 角色
